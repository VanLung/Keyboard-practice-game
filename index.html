<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán G√µ Ph√≠m - Thi ƒê·∫•u ƒê·ªôi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gochi+Hand&family=Patrick+Hand&display=swap');

        :root {
            --team1-color: #FF9AA2;
            --team2-color: #FFB7B2;
            --team3-color: #FFDAC1;
            --team4-color: #E2F0CB;
        }

        * {
            font-family: 'Patrick Hand', cursive;
        }

        body {
            background-color: #f0f9ff;
            background-image: url('https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/9f6a08c9-a973-4973-9cc4-357e897d5f95.png');
            background-size: cover;
            background-attachment: fixed;
        }

        .title {
            font-family: 'Gochi Hand', cursive;
            color: #3b82f6;
            text-shadow: 2px 2px 0px #fff;
        }

        .key {
            transition: all 0.1s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        .key.active {
            transform: translateY(4px);
            box-shadow: 0 1px 2px -1px rgba(0, 0, 0, 0.2);
            filter: brightness(0.9);
        }

        .correct {
            background-color: #86efac !important;
        }

        .wrong {
            background-color: #fca5a5 !important;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .team-1 {
            background-color: var(--team1-color);
        }

        .team-2 {
            background-color: var(--team2-color);
        }

        .team-3 {
            background-color: var(--team3-color);
        }

        .team-4 {
            background-color: var(--team4-color);
        }

        .celebrate {
            animation: celebrate 2s infinite;
        }

        @keyframes celebrate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .progress-bar {
            transition: width 0.3s ease;
        }

        /* Effect for correct key press */
        .correct-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-4">
    <div class="absolute inset-0 bg-white bg-opacity-70 z-0"></div>

    <div class="relative z-10 w-full max-w-4xl">
        <!-- Mode Selection -->
        <div id="modeSelection" class="text-center mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold mb-6">Ch·ªçn ch·∫ø ƒë·ªô</h2>
            <div class="flex justify-center gap-4">
                <button onclick="showTeacherMode()" class="px-6 py-3 bg-blue-500 text-white rounded-lg text-xl hover:bg-blue-600">
                    Gi√°o vi√™n
                </button>
                <button onclick="showStudentMode()" class="px-6 py-3 bg-green-500 text-white rounded-lg text-xl hover:bg-green-600">
                    H·ªçc sinh
                </button>
            </div>
        </div>

        <!-- Header -->
        <header class="text-center mb-8 hidden" id="gameHeader">
            <h1 class="title text-5xl md:text-6xl mb-2">Luy·ªán G√µ Ph√≠m</h1>
            <p class="text-xl">Thi ƒë·∫•u ƒë·ªìng ƒë·ªôi - Ai nhanh h∆°n?</p>
        </header>

        <!-- Game Area -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 relative overflow-hidden">
            <!-- Team Selection -->
            <div id="teamSetup" class="mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-center">Thi·∫øt l·∫≠p ƒë·ªôi ch∆°i</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="team-option p-4 rounded-lg">
                        <label class="block text-lg font-semibold mb-2">S·ªë ƒë·ªôi ch∆°i</label>
                        <div class="flex justify-center gap-2">
                            <button onclick="setTeamCount(2)" class="px-4 py-2 bg-blue-100 rounded-lg hover:bg-blue-200">2 ƒê·ªôi</button>
                            <button onclick="setTeamCount(3)" class="px-4 py-2 bg-blue-100 rounded-lg hover:bg-blue-200">3 ƒê·ªôi</button>
                            <button onclick="setTeamCount(4)" class="px-4 py-2 bg-blue-100 rounded-lg hover:bg-blue-200">4 ƒê·ªôi</button>
                        </div>
                    </div>
                    <div class="time-option p-4 rounded-lg">
                        <label class="block text-lg font-semibold mb-2">Th·ªùi gian (gi√¢y)</label>
                        <select id="gameTime" class="w-full p-2 border rounded-lg">
                            <option value="30">30 gi√¢y</option>
                            <option value="60" selected>60 gi√¢y</option>
                            <option value="90">90 gi√¢y</option>
                            <option value="120">120 gi√¢y</option>
                        </select>
                    </div>
                </div>

                <div id="teamNamesContainer" class="hidden grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

                <div class="text-center">
                    <div id="gameCodeDisplay" class="mb-4 hidden">
                        <p class="font-bold">M√£ tr√≤ ch∆°i:</p>
                        <p id="gameCodeValue" class="text-2xl font-mono bg-gray-100 p-2 rounded"></p>
                        <p class="text-sm text-gray-600">H·ªçc sinh nh·∫≠p m√£ n√†y ƒë·ªÉ tham gia</p>
                    </div>
                    <button id="startGameBtn" onclick="startGame()"
                        class="px-6 py-3 bg-green-500 text-white rounded-lg text-xl hover:bg-green-600 hidden">
                        B·∫ÆT ƒê·∫¶U CU·ªòC CHI·∫æN!
                    </button>
                </div>
            </div>

            <!-- Game Screen (Student Mode - Simplified for Single Player) -->
            <div id="studentSetup" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4 text-center">Tham gia tr√≤ ch∆°i</h2>
                <div class="mb-4">
                    <label class="block text-lg font-semibold mb-2">T√™n c·ªßa b·∫°n</label>
                    <input type="text" id="studentName" class="w-full p-3 border rounded-lg text-center text-xl"
                           placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
                </div>
                <button onclick="startSinglePlayerGame()" class="w-full py-3 bg-green-500 text-white rounded-lg text-xl hover:bg-green-600">
                    B·∫Øt ƒë·∫ßu ch∆°i ƒë∆°n
                </button>
            </div>

            <div id="gameScreen" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <div id="timer" class="text-2xl font-bold">1:00</div>
                    <button onclick="endGame()" class="px-4 py-1 bg-red-500 text-white rounded-lg">K·∫øt th√∫c</button>
                </div>

                <!-- Teams progress (still shown for visual, but only one "team" in single player) -->
                <div id="teamsProgress" class="mb-6 grid grid-cols-1 gap-2"></div>

                <!-- Current team playing -->
                <div id="currentTeamDisplay" class="text-center py-2 rounded-lg mb-4 text-xl font-bold"></div>

                <!-- Typing words -->
                <div id="wordDisplay" class="text-center text-3xl font-bold mb-8 py-4 px-2 bg-gray-100 rounded-lg">
                    Nh·∫•n ph√≠m b·∫•t k·ª≥ ƒë·ªÉ b·∫Øt ƒë·∫ßu
                </div>

                <!-- Keyboard -->
                <div id="keyboard" class="grid grid-cols-10 gap-1 mb-4">
                    <!-- Keyboard will be generated here by JavaScript -->
                </div>

                <!-- Scoreboard -->
                <div id="scoreboard" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-center">K·∫æT QU·∫¢</h2>
                    <div id="scoreboardTeams" class="grid grid-cols-1 gap-4"></div>
                    <div class="text-center mt-6">
                        <button onclick="resetGame()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Ch∆°i l·∫°i
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4">H∆∞·ªõng d·∫´n ch∆°i</h2>
            <ol class="list-decimal pl-5 space-y-2">
                <li>Ch·ªçn s·ªë ƒë·ªôi ch∆°i v√† ƒë·∫∑t t√™n cho m·ªói ƒë·ªôi (ch·∫ø ƒë·ªô Gi√°o vi√™n)</li>
                <li>Ho·∫∑c nh·∫≠p t√™n ƒë·ªÉ ch∆°i ƒë∆°n (ch·∫ø ƒë·ªô H·ªçc sinh)</li>
                <li>G√µ ƒë√∫ng ƒë·ªÉ ghi ƒëi·ªÉm, g√µ sai s·∫Ω b·ªã tr·ª´ th·ªùi gian</li>
                <li>ƒê·ªôi n√†o ghi ƒë∆∞·ª£c nhi·ªÅu ƒëi·ªÉm nh·∫•t s·∫Ω th·∫Øng! (ho·∫∑c b·∫°n ghi ƒë∆∞·ª£c nhi·ªÅu ƒëi·ªÉm nh·∫•t trong ch∆°i ƒë∆°n)</li>
            </ol>
        </div>
    </div>

    <!-- Audio elements -->
    <audio id="correctSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
    <audio id="wrongSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>
    <audio id="winSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>

    <script>
        // Simple Telex converter (for demonstration, a more robust library might be better for production)
        // This is a simplified version. For full Telex rules, consider a dedicated library.
        const telexMap = {
            'a': { 's': '√°', 'f': '√†', 'r': '·∫£', 'x': '√£', 'j': '·∫°', 'w': 'ƒÉ', '^': '√¢' },
            'e': { 's': '√©', 'f': '√®', 'r': '·∫ª', 'x': '·∫Ω', 'j': '·∫π', '^': '√™' },
            'i': { 's': '√≠', 'f': '√¨', 'r': '·ªâ', 'x': 'ƒ©', 'j': '·ªã' },
            'o': { 's': '√≥', 'f': '√≤', 'r': '·ªè', 'x': '√µ', 'j': '·ªç', 'w': '∆°', '^': '√¥' },
            'u': { 's': '√∫', 'f': '√π', 'r': '·ªß', 'x': '≈©', 'j': '·ª•', 'w': '∆∞' },
            'y': { 's': '√Ω', 'f': '·ª≥', 'r': '·ª∑', 'x': '·ªπ', 'j': '·ªµ' },
            'd': { 'd': 'ƒë' }
        };

        const accentMarks = ['s', 'f', 'r', 'x', 'j']; // S·∫Øc, Huy·ªÅn, H·ªèi, Ng√£, N·∫∑ng
        const specialCharModifiers = ['d', 'w', '^']; // ƒê, ∆Ø/∆†/ƒÇ, √Ç/√ä/√î

        function applyTelex(baseChar, modifier) {
            baseChar = baseChar.toLowerCase();
            modifier = modifier.toLowerCase();

            if (telexMap[baseChar] && telexMap[baseChar][modifier]) {
                return telexMap[baseChar][modifier];
            }
            return null; // No Telex conversion
        }

        // This function will be used to convert the word to its "base" form for comparison
        // and to track the state of the input.
        function removeVietnameseAccents(str) {
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g, "a");
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g, "e");
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g, "i");
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g, "o");
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g, "u");
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g, "y");
            str = str.replace(/ƒë/g, "d");
            return str;
        }
    </script>

    <script>
        // Game state and server connection (SIMPLIFIED FOR SINGLE PLAYER)
        const gameState = {
            teams: [], // Will contain only one "team" for single player
            currentTeamIndex: 0,
            isPlaying: false,
            timeLeft: 60,
            timerInterval: null,
            currentWord: '',
            currentIndex: 0,
            score: {}, // Will track score for the single "team"
            playerScores: {}, // Will track score for the single player
            // socket: null, // REMOVED: No WebSocket connection for single player
            gameId: null, // Kept for consistency, but not used for multi-player
            inputBuffer: '', // NEW: Stores the user's current input for Telex processing
            words: [
                "xin ch√†o", "h·ªçc sinh", "l·ªõp ba", "m√°i tr∆∞·ªùng", "th·∫ßy c√¥",
                "b·∫°n b√®", "ƒëo√†n k·∫øt", "h·ªçc t·∫≠p", "si√™ng nƒÉng", "vui v·∫ª",
                "h·∫°nh ph√∫c", "gia ƒë√¨nh", "qu√™ h∆∞∆°ng", "vi·ªát nam", "hoa ƒëi·ªÉm m∆∞·ªùi",
                "tr∆∞·ªùng h·ªçc", "l·ªÖ ph√©p", "chƒÉm ch·ªâ", "ngoan ngo√£n", "th√¥ng minh",
                "s·∫°ch s·∫Ω", "g·ªçn g√†ng", "vƒÉn minh", "th√¢n thi·ªán", "h√≤a ƒë·ªìng"
            ]
        };

        // DOM elements
        const modeSelection = document.getElementById('modeSelection');
        const gameHeader = document.getElementById('gameHeader');
        const teamSetup = document.getElementById('teamSetup');
        const teamNamesContainer = document.getElementById('teamNamesContainer');
        const startGameBtn = document.getElementById('startGameBtn');
        const studentSetup = document.getElementById('studentSetup'); // Added
        const gameScreen = document.getElementById('gameScreen');
        const timer = document.getElementById('timer');
        const teamsProgress = document.getElementById('teamsProgress');
        const currentTeamDisplay = document.getElementById('currentTeamDisplay');
        const wordDisplay = document.getElementById('wordDisplay');
        const keyboard = document.getElementById('keyboard');
        const scoreboard = document.getElementById('scoreboard');
        const scoreboardTeams = document.getElementById('scoreboardTeams');
        const gameTimeSelect = document.getElementById('gameTime');
        const studentNameInput = document.getElementById('studentName'); // Added

        // Audio elements
        const correctSound = document.getElementById('correctSound');
        const wrongSound = document.getElementById('wrongSound');
        const winSound = document.getElementById('winSound');

        // Game modes
        function showTeacherMode() {
            modeSelection.classList.add('hidden');
            gameHeader.classList.remove('hidden');
            teamSetup.classList.remove('hidden');
            studentSetup.classList.add('hidden'); // Hide student setup
            gameScreen.classList.add('hidden'); // Hide game screen
            scoreboard.classList.add('hidden'); // Hide scoreboard

            // Reset game state for teacher mode
            gameState.teams = [];
            gameState.score = {};
            gameState.playerScores = {};
            teamNamesContainer.innerHTML = '';
            teamNamesContainer.classList.add('hidden');
            startGameBtn.classList.add('hidden');
            document.getElementById('gameCodeDisplay').classList.remove('hidden'); // Show game code for teacher
            gameState.gameId = Math.random().toString(36).substring(2, 6).toUpperCase();
            document.getElementById('gameCodeValue').textContent = gameState.gameId;
        }

        function showStudentMode() {
            modeSelection.classList.add('hidden');
            gameHeader.classList.remove('hidden');
            teamSetup.classList.add('hidden'); // Hide teacher setup
            studentSetup.classList.remove('hidden'); // Show student setup
            gameScreen.classList.add('hidden'); // Hide game screen
            scoreboard.classList.add('hidden'); // Hide scoreboard

            // Reset game state for student mode (single player)
            gameState.teams = [];
            gameState.score = {};
            gameState.playerScores = {};
            studentNameInput.value = ''; // Clear student name input
        }

        // Simplified joinGame for single player
        function startSinglePlayerGame() {
            const name = studentNameInput.value.trim();

            if (name) {
                // For single player, create one "team" with the player's name
                const singlePlayerTeamName = `Ng∆∞·ªùi ch∆°i: ${name}`;
                gameState.teams = [{ name: singlePlayerTeamName }];
                gameState.score[singlePlayerTeamName] = 0;
                gameState.playerScores[name] = 0; // Track player's score

                studentSetup.classList.add('hidden');
                startGame(true); // Start the game in single player mode
            } else {
                alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
            }
        }

        // Initialize the game (simplified)
        function init() {
            // Generate keyboard
            generateKeyboard();

            // Set up event listeners
            document.addEventListener('keydown', handleKeyPress);
        }

        // Set number of teams (Teacher mode only)
        function setTeamCount(count) {
            teamNamesContainer.innerHTML = '';
            teamNamesContainer.classList.remove('hidden');
            teamNamesContainer.classList.add('grid');

            const teamColors = ['team-1', 'team-2', 'team-3', 'team-4'];

            for (let i = 0; i < count; i++) {
                const teamDiv = document.createElement('div');
                teamDiv.className = `p-4 rounded-lg ${teamColors[i]}`;

                teamDiv.innerHTML = `
                    <label class="block text-lg font-semibold mb-2">T√™n ƒë·ªôi ${i+1}</label>
                    <input type="text" id="teamName${i}" class="w-full p-2 border rounded-lg"
                           placeholder="Nh·∫≠p t√™n ƒë·ªôi" value="ƒê·ªôi ${i+1}">
                `;

                teamNamesContainer.appendChild(teamDiv);
            }

            startGameBtn.classList.remove('hidden');
        }

        // Start the game
        function startGame(isSinglePlayer = false) {
            if (!isSinglePlayer) {
                // Get team names from teacher setup
                gameState.teams = [];
                gameState.score = {};

                const teamInputs = teamNamesContainer.querySelectorAll('input[type="text"]');
                teamInputs.forEach((input, index) => {
                    const name = input.value.trim() || `ƒê·ªôi ${index + 1}`;
                    gameState.teams.push({ name: name }); // Store as object for consistency
                    gameState.score[name] = 0;
                });
            }

            // Set game time
            gameState.timeLeft = parseInt(gameTimeSelect.value);
            updateTimerDisplay();

            // Initialize game state
            gameState.currentTeamIndex = 0;
            gameState.isPlaying = true;
            gameState.inputBuffer = ''; // Reset input buffer for new game

            // Hide setup, show game
            teamSetup.classList.add('hidden');
            studentSetup.classList.add('hidden'); // Hide student setup
            gameScreen.classList.remove('hidden');
            scoreboard.classList.add('hidden');

            // Start timer
            clearInterval(gameState.timerInterval); // Clear any existing timer
            gameState.timerInterval = setInterval(updateTimer, 1000);

            // Show current team
            updateCurrentTeamDisplay();

            // Generate first word
            newWord();
        }

        // Update timer
        function updateTimer() {
            gameState.timeLeft--;
            updateTimerDisplay();

            if (gameState.timeLeft <= 0) {
                endGame();
            }
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = gameState.timeLeft % 60;
            timer.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        // Update current team display
        function updateCurrentTeamDisplay() {
            if (gameState.teams.length > 0) {
                const teamName = gameState.teams[gameState.currentTeamIndex].name;
                const teamColors = ['bg-pink-200', 'bg-red-200', 'bg-orange-200', 'bg-green-200'];
                currentTeamDisplay.textContent = `ƒê·ªôi hi·ªán t·∫°i: ${teamName}`;
                currentTeamDisplay.className = `text-center py-2 rounded-lg mb-4 text-xl font-bold ${teamColors[gameState.currentTeamIndex]}`;
            } else {
                currentTeamDisplay.textContent = 'B·∫Øt ƒë·∫ßu ch∆°i ƒë·ªÉ xem ƒë·ªôi';
                currentTeamDisplay.className = 'text-center py-2 rounded-lg mb-4 text-xl font-bold bg-gray-200';
            }

            // Update progress bars
            updateProgressBars();
        }

        // Update progress bars for all teams
        function updateProgressBars() {
            teamsProgress.innerHTML = '';

            gameState.teams.forEach((team, index) => {
                const teamScore = gameState.score[team.name] || 0;
                const teamColors = ['bg-pink-500', 'bg-red-500', 'bg-orange-500', 'bg-green-500'];

                const teamDiv = document.createElement('div');
                teamDiv.className = 'space-y-1';
                teamDiv.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-medium">${team.name}</span>
                        <span class="font-bold">${teamScore} ƒëi·ªÉm</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="progress-bar h-4 rounded-full ${teamColors[index]}"
                             style="width: ${Math.min(teamScore, 100)}%"></div>
                    </div>
                `;

                teamsProgress.appendChild(teamDiv);
            });
        }

        // Generate a new random word
        function newWord() {
            gameState.currentWord = gameState.words[Math.floor(Math.random() * gameState.words.length)];
            gameState.currentIndex = 0;
            gameState.inputBuffer = ''; // Reset input buffer for new word

            // Display word with first character highlighted
            displayWord();
        }

        // Display the current word with highlighting
        function displayWord() {
            // Display the user's input buffer, followed by the remaining part of the target word
            const targetRemaining = gameState.currentWord.substring(gameState.inputBuffer.length);

            wordDisplay.innerHTML = `
                <span class="text-blue-600">${gameState.inputBuffer}</span>
                <span>${targetRemaining}</span>
            `;

            // If the input buffer matches the current word, it's completed
            if (gameState.inputBuffer === gameState.currentWord) {
                // Word completed
                wordDisplay.textContent = gameState.currentWord;

                // Add score for current team and player
                const currentTeam = gameState.teams[gameState.currentTeamIndex];
                gameState.score[currentTeam.name] = (gameState.score[currentTeam.name] || 0) + 1;

                // If single player, update player's score
                const playerName = studentNameInput.value.trim();
                if (playerName) {
                    gameState.playerScores[playerName] = (gameState.playerScores[playerName] || 0) + 1;
                }

                // Play correct sound
                correctSound.currentTime = 0;
                correctSound.play();

                // Highlight word briefly
                wordDisplay.classList.add('bg-green-100');
                setTimeout(() => {
                    wordDisplay.classList.remove('bg-green-100');

                    // Switch to next team (or just stay on the same "team" for single player)
                    switchTeam();

                    // New word after short delay
                    setTimeout(newWord, 500);
                }, 500);

                // Update progress
                updateProgressBars();
            }
        }

        // Switch to next team
        function switchTeam() {
            gameState.currentTeamIndex = (gameState.currentTeamIndex + 1) % gameState.teams.length;
            updateCurrentTeamDisplay();
        }

        // Handle key press
        function handleKeyPress(e) {
            if (!gameState.isPlaying || gameState.currentWord.length === 0) return;

            const pressedKey = e.key.toLowerCase();

            // Handle Backspace
            if (e.key === 'Backspace') {
                if (gameState.inputBuffer.length > 0) {
                    gameState.inputBuffer = gameState.inputBuffer.slice(0, -1);
                    displayWord();
                }
                return;
            }

            // Only process alphanumeric keys and common punctuation
            if (!/^[a-z0-9\s.,;/?]$/.test(pressedKey)) {
                return; // Ignore other keys like Shift, Ctrl, Alt, F-keys etc.
            }

            // Apply Telex conversion
            let charToAdd = pressedKey;
            if (gameState.inputBuffer.length > 0) {
                const lastCharInInput = gameState.inputBuffer[gameState.inputBuffer.length - 1];
                const convertedChar = applyTelex(lastCharInInput, pressedKey);

                if (convertedChar) {
                    gameState.inputBuffer = gameState.inputBuffer.slice(0, -1) + convertedChar;
                    charToAdd = ''; // Don't add the modifier key as a new character
                }
            }
            
            if (charToAdd) { // Add the character if it's not a modifier that was consumed by Telex
                gameState.inputBuffer += charToAdd;
            }

            // Compare the current input buffer with the target word
            const currentInputNormalized = removeVietnameseAccents(gameState.inputBuffer);
            const targetWordNormalized = removeVietnameseAccents(gameState.currentWord);

            // Check if the current input matches the beginning of the target word
            if (targetWordNormalized.startsWith(currentInputNormalized)) {
                // If the input buffer matches the full word, it's correct
                if (gameState.inputBuffer === gameState.currentWord) {
                    // Word completed, displayWord() will handle scoring and new word
                    displayWord();
                } else {
                    // Input is correct so far, just update display
                    displayWord();
                }
            } else {
                // Wrong key
                wrongSound.currentTime = 0;
                wrongSound.play();

                // Subtract time for wrong key (minimum 1 second)
                gameState.timeLeft = Math.max(1, gameState.timeLeft - 1);
                updateTimerDisplay();

                // Show wrong feedback
                wordDisplay.classList.add('wrong');
                setTimeout(() => wordDisplay.classList.remove('wrong'), 500);

                // Revert input buffer to the last correct state or clear it
                // For simplicity, we'll just remove the last incorrect character
                if (gameState.inputBuffer.length > 0) {
                    gameState.inputBuffer = gameState.inputBuffer.slice(0, -1);
                }
                displayWord(); // Update display after reverting
            }

            // Highlight the pressed key on keyboard (visual feedback)
            highlightKey(pressedKey, targetWordNormalized.startsWith(currentInputNormalized));
        }

        // Highlight key on keyboard
        function highlightKey(key, isCorrect) {
            const keyButtons = document.querySelectorAll('.key-btn');

            for (const btn of keyButtons) {
                if (btn.textContent.toLowerCase() === key) {
                    btn.classList.add('active');
                    if (isCorrect) {
                        btn.classList.add('correct');
                        const effect = document.createElement('div');
                        effect.className = 'correct-effect animate-ping';
                        btn.appendChild(effect);
                        setTimeout(() => effect.remove(), 300);
                    } else {
                        btn.classList.add('wrong');
                    }

                    setTimeout(() => {
                        btn.classList.remove('active', 'correct', 'wrong');
                    }, 300);
                    break;
                }
            }
        }

        // Generate keyboard
        function generateKeyboard() {
            const rows = [
                ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
                ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
                ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', ';'],
                ['z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '/']
            ];

            keyboard.innerHTML = '';

            rows.forEach(row => {
                row.forEach(key => {
                    const keyBtn = document.createElement('div');
                    keyBtn.className = 'key text-center py-3 bg-gray-100 rounded-lg font-bold cursor-pointer select-none key-btn';
                    keyBtn.textContent = key;
                    keyBtn.addEventListener('click', () => {
                        handleKeyPress({key: key});
                    });
                    keyboard.appendChild(keyBtn);
                });
            });
        }

        // End the game
        function endGame() {
            gameState.isPlaying = false;
            clearInterval(gameState.timerInterval);

            // Hide game, show scoreboard
            gameScreen.classList.add('hidden');
            scoreboard.classList.remove('hidden');

            // Calculate winner
            const scores = Object.entries(gameState.score);
            scores.sort((a, b) => b[1] - a[1]);

            // Display scores
            scoreboardTeams.innerHTML = '';
            scores.forEach(([teamName, score], index) => {
                const medalColors = ['text-yellow-500', 'text-gray-400', 'text-amber-700'];
                const medalIcons = ['ü•á', 'ü•à', 'ü•â'];

                const teamDiv = document.createElement('div');
                teamDiv.className = `flex justify-between items-center p-4 rounded-lg ${index < 3 ? 'bg-gray-100' : ''}`;

                let medalHtml = '';
                if (index < 3) {
                    medalHtml = `
                        <span class="text-2xl ${medalColors[index]}">
                            ${medalIcons[index]}
                        </span>
                    `;
                }

                // Display player scores if available (for single player)
                let playerScoresHtml = '';
                const playerName = studentNameInput.value.trim();
                if (playerName && gameState.playerScores[playerName] !== undefined) {
                    playerScoresHtml = `<div class="text-sm mt-2">${playerName}: ${gameState.playerScores[playerName]} ƒëi·ªÉm</div>`;
                }


                teamDiv.innerHTML = `
                    <div class="flex items-center gap-4">
                        ${medalHtml}
                        <span class="text-xl font-bold">${teamName}</span>
                    </div>
                    <span class="text-xl font-bold">${score} ƒëi·ªÉm</span>
                    ${playerScoresHtml}
                `;

                if (index === 0) {
                    setTimeout(() => {
                        winSound.play();
                        teamDiv.classList.add('celebrate');
                    }, 500);
                }

                scoreboardTeams.appendChild(teamDiv);
            });
        }

        // Reset the game
        function resetGame() {
            scoreboard.classList.add('hidden');
            modeSelection.classList.remove('hidden'); // Go back to mode selection
            gameHeader.classList.add('hidden');
            teamSetup.classList.add('hidden');
            studentSetup.classList.add('hidden');
            gameScreen.classList.add('hidden');
            wordDisplay.textContent = 'Nh·∫•n ph√≠m b·∫•t k·ª≥ ƒë·ªÉ b·∫Øt ƒë·∫ßu';
            gameState.teams = [];
            gameState.score = {};
            gameState.playerScores = {};
            gameState.inputBuffer = ''; // Reset input buffer
        }

        // Initialize the game when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
